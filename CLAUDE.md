# CLAUDE.md — AI Assistant Guide for audiobook_catalog

## Project Overview

**audiobook_catalog** is a Python application that scans a local audiobook library (`.m4b`, `.m4a`, `.mp4` files), extracts metadata from embedded MP4 tags, and generates:
- A timestamped HTML+CSV catalog in `output_files/`
- A deployable `site/` directory (HTML, CSV, cover images, static assets)
- A statistics page (`site/stats.html`)
- A book-title guessing game page (`site/guess-game.html`)

The `site/` directory is published to **GitHub Pages** on every push to `main`/`master`.

---

## Repository Layout

```
audiobook_catalog/
├── app/
│   ├── config.py              # Env-driven configuration (ROOT_DIR, SITE_DIR, etc.)
│   ├── main.py                # Entry point — orchestrates the full pipeline
│   ├── metadata.py            # MP4/M4B tag extraction via mutagen
│   ├── writers.py             # CSV writing, HTML rendering, site staging
│   ├── core/
│   │   ├── index_utils.py     # Series index normalization (numeric/roman/word)
│   │   └── people.py          # Author/narrator name normalization
│   ├── extractors/
│   │   ├── tags.py            # Low-level tag helpers
│   │   └── covers.py          # Cover art extraction
│   ├── parsers/
│   │   ├── title.py           # Series/index parsing from title strings
│   │   └── title_patterns.py  # Regex patterns for title parsing (no logic here)
│   ├── tools/
│   │   ├── generate_stats.py        # Calculates stats and writes site/stats.html
│   │   ├── send_discord_notification.py  # Sends Discord webhook on deploy
│   │   ├── detect_new_books.py      # Diffs catalog CSVs to find new titles
│   │   ├── generate_author_map.py   # Builds author → Google Drive folder ID map
│   │   ├── inspect_tags.py          # Debug tool: dumps MP4 tags for a file
│   │   └── book_sort.py             # Sorting helpers
│   └── web/
│       ├── html_builder.py          # Template rendering (fills {{PLACEHOLDERS}})
│       ├── static/                  # JS and CSS served from site/static/
│       └── templates/               # HTML templates (index.html, guess-game.html, etc.)
├── tests/
│   ├── test_title_parsing.py
│   ├── test_index_utils.py
│   ├── test_people_normalization.py
│   ├── test_html_builder.py
│   ├── test_discord_embeds.py
│   ├── test_catalog_completeness.py
│   └── test_integration.py
├── site/                      # Deployed GitHub Pages output (committed to repo)
│   ├── index.html
│   ├── catalog.csv
│   ├── stats.html
│   ├── guess-game.html
│   ├── covers/                # Extracted cover art (author/title.jpg)
│   └── static/                # CSS and JS assets
├── output_files/              # Timestamped local outputs (gitignored)
├── scripts/                   # Utility scripts (see scripts/README.md)
├── .github/workflows/
│   ├── tests.yml              # Runs unit tests on push/PR
│   ├── lint.yml               # Runs black/flake8/isort/bandit
│   └── deploy.yml             # Tests → Lint → Build catalog → Deploy → Discord
├── pyproject.toml             # black/isort/bandit/pytest config
├── requirements.txt           # Runtime + dev dependencies
├── .pre-commit-config.yaml    # Pre-commit hook definitions
├── run_tests.py               # Custom test runner (wraps unittest discover)
├── .env.example               # Template for environment variables
└── setup-dev.sh / setup-dev.bat  # Dev environment setup scripts
```

---

## Data Pipeline

```
Library dir (ROOT_DIR)
  └── *.m4b / *.m4a / *.mp4
        │
        ▼
  walk_library()          — app/metadata.py
        │
        ▼
  extract_metadata()      — mutagen MP4 tags
    ├── title, author, narrator, year, genre, duration
    ├── series + series_index:
    │     1. SRNM / SRSQ vendor tags  (preferred)
    │     2. ----:com.apple.iTunes freeform tags
    │     3. title parsing fallback   — app/parsers/title.py
    ├── description (HTML → plain text)
    └── cover art → output_files/covers/<author>/<title>.jpg
        │
        ▼
  rows: List[Dict[str, str]]
        │
        ├── write_csv()             → output_files/audiobook_catalog_<stamp>.csv
        ├── render_output_html()    → output_files/audiobook_catalog_<stamp>.html
        └── stage_site_files()      → site/
              ├── catalog.csv
              ├── index.html        (rendered with {{PLACEHOLDERS}})
              ├── stats.html        (generated by tools/generate_stats.py)
              ├── guess-game.html   (copied from templates/)
              ├── covers/
              └── static/
```

---

## Metadata Fields

Every row in the catalog is a `Dict[str, str]` with these keys:

| Field | Description |
|---|---|
| `title` | Book title from `©nam` tag |
| `series` | Series name (vendor tag → freeform → title parse) |
| `series_index_display` | Human-readable index: `"1"`, `"2.5"`, `"1-3"` |
| `series_index_sort` | Float string for sort ordering |
| `author` | Normalized author(s) from `©ART` |
| `narrator` | Normalized narrator(s) from `©wrt` |
| `year` | Publication year from `©day` |
| `genre` | Genre from `©gen` |
| `duration_hhmm` | Duration formatted as `"H:MM"` |
| `cover_href` | Site-relative path: `"covers/Author/Title.jpg"` |
| `desc` | Plain-text description (HTML stripped) |

---

## Configuration (`.env`)

Copy `.env.example` to `.env` and set these variables:

| Variable | Required | Description |
|---|---|---|
| `ROOT_DIR` | **Yes** | Absolute path to your audiobooks folder |
| `DRIVE_FOLDER_URL` | No | Google Drive folder URL shown in header |
| `INSPECT_DIR` | No | Override directory for `inspect_tags` tool |
| `OUTPUT_DIR` | No | Defaults to `output_files/` |
| `SITE_DIR` | No | Defaults to `site/` |

GitHub Actions secrets:

| Secret | Description |
|---|---|
| `DISCORD_WEBHOOK` | Discord webhook URL for deploy notifications |

---

## Running the Application

```bash
# Generate catalog (requires ROOT_DIR set in .env or environment)
python -m app.main

# Run tests
python run_tests.py

# Run a specific test module
python run_tests.py test_title_parsing

# Run utility tools
python -m app.tools.generate_stats
python -m app.tools.generate_author_map
python -m app.tools.inspect_tags
python -m app.tools.detect_new_books
```

---

## Development Setup

```bash
# Linux/Mac
bash setup-dev.sh

# Windows
setup-dev.bat

# Manual setup
pip install -r requirements.txt
pip install pre-commit
pre-commit install

cp .env.example .env
# Edit .env — set ROOT_DIR to your audiobook library path
```

---

## Code Style and Quality

All formatting and linting is enforced by pre-commit hooks and CI.

| Tool | Config | Line Length |
|---|---|---|
| **black** | `pyproject.toml [tool.black]` | 127 |
| **flake8** | `.pre-commit-config.yaml` | 127, ignore E203/W503 |
| **isort** | `pyproject.toml [tool.isort]` | 127, black profile |
| **bandit** | `pyproject.toml [tool.bandit]` | Skip B101 (asserts OK in tests) |

**Key conventions:**
- Use `from __future__ import annotations` at the top of every module
- Return `None` (not empty string) when a value is truly absent; the metadata dict uses `""` for absent fields
- Tag keys are defined as constants at the top of `metadata.py` (e.g., `K_TITLE = "\xa9nam"`)
- `normalize_people_field()` is the canonical function for author/narrator name normalization — defined in `app/core/people.py` and re-exported from `app/metadata.py`
- Series index normalization always goes through `app/core/index_utils.normalize_index()` and `sort_key_for_index()`
- Excluded directories from linting: `old_versions/`, `output_files/`, `site/`

---

## HTML Template System

`app/web/html_builder.py` reads `app/web/templates/index.html` and replaces these placeholders:

| Placeholder | Replaced with |
|---|---|
| `{{GENERATED_AT}}` | Timestamp string |
| `{{CSV_LINK}}` | Relative path to catalog CSV |
| `{{DRIVE_LINK_BLOCK}}` | HTML anchor for Google Drive (or empty string) |
| `{{TABLE_ROWS}}` | `<tr>` elements for the HTML table |
| `{{CARDS}}` | `.ab-card` div elements for card view |
| `{{AUTHOR_MAP_JSON}}` | JSON map of author → Drive folder ID |

Table column order in `_row_cells()` **must match** the `<thead>` in `templates/index.html`:
Cover → Title → Series → # → Author → Narrator → Year → Genre → Duration

---

## CI/CD Workflows

### `tests.yml`
Runs on push/PR to `main`, `master`, `develop`. Executes `python run_tests.py -v`.
Can be called by other workflows via `workflow_call`.

### `lint.yml`
Runs on push. Executes black/flake8/isort/bandit checks.

### `deploy.yml`
Runs on push to `main`/`master` (also manually triggerable):
1. Calls `tests.yml` and `lint.yml` in parallel
2. On pass: runs `python -m app.main` (catalog generation, may fail in CI — no library)
3. Verifies or creates a placeholder `site/index.html`
4. Uploads `site/` as GitHub Pages artifact and deploys
5. Runs `detect_new_books.py` (compares current vs previous `site/catalog.csv` via git)
6. Sends Discord notification via `send_discord_notification.py` if `DISCORD_WEBHOOK` is set

---

## Author Drive Map

`author_drive_map.json` (lives in the **parent** of this repo, not committed here) maps author names to Google Drive folder IDs:

```json
{
  "Brandon Sanderson": "1abc...",
  "Martha Wells": ""
}
```

- Generate the file with `python -m app.tools.generate_author_map`
- Fill in the Drive folder IDs manually
- The map is injected as `{{AUTHOR_MAP_JSON}}` in the HTML template

---

## Testing Conventions

- Framework: `unittest` (standard library)
- Test discovery: `python run_tests.py` (discovers `tests/test_*.py`)
- Pytest is also configured in `pyproject.toml` for direct `pytest` use
- Tests do **not** require a real library — they use hardcoded strings and mock data
- `bandit` skips `B101` (assert statements are used freely in tests)
- Key test areas: title parsing, index normalization, people normalization, HTML escaping, Discord embed structure

---

## Series Index Normalization Rules (`app/core/index_utils.py`)

| Input | `normalize_index()` output | `sort_key_for_index()` output |
|---|---|---|
| `"3"` | `"3"` | `3.0` |
| `"2.5"` | `"2.5"` | `2.5` |
| `"1-3"` | `"1-3"` | `1.0` |
| `"IV"` | `"4"` | `4.0` |
| `"Three"` | `"3"` | `3.0` |
| `""` | `""` | `None` |

---

## Common Pitfalls

1. **No library in CI**: `python -m app.main` silently produces no rows in GitHub Actions — the deploy workflow handles this with a placeholder `site/index.html`.
2. **`author_drive_map.json` location**: The file is expected one level **above** this repo root, not inside it. `html_builder.py` searches several paths and falls back to `{}` silently.
3. **Cover paths are site-relative**: `cover_href` is always like `"covers/Author/Title.jpg"` — never an absolute path.
4. **Mutagen tag access**: Tags may be `None`, lists, `bytes`, `MP4FreeForm`, or `tuple`. Always use `first_str()` and `get_tag_any()` helpers from `metadata.py`.
5. **`output_files/` is gitignored**: Only `site/` is committed and deployed.
6. **Template column order**: If you add/remove columns in `html_builder.py:_row_cells()`, update the `<thead>` in `templates/index.html` to match, or sorting will break.
