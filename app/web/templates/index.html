<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Audiobook Catalog</title>
<style>
/* =============== Theming =============== */
:root{
  --pad:14px; --radius:14px;
  --bg:#ffffff; --bg-2:#fafafa;
  --text:#1b1f23; --muted:#5f6b7a;
  --border:#e5e7eb;
  --chip:#f2f2f2;
  --btn-bg:#f7f7f7; --btn-bg-active:#e8f0fe; --btn-border:#ddd; --btn-active:#b6c6ff;
  --row-alt:#fcfcfc; --row-hover:#f5f9ff;
  --overlay: rgba(0,0,0,.55);
}
body.dark{
  --bg:#0f141a; --bg-2:#121820;
  --text:#e7eef7; --muted:#9fb0c6;
  --border:#263241;
  --chip:#1f2a37;
  --btn-bg:#1a2330; --btn-bg-active:#16324a; --btn-border:#2b3a4d; --btn-active:#2d72d2;
  --row-alt:#0f1722; --row-hover:#132033;
  --overlay: rgba(0,0,0,.65);
}

/* =============== Base Layout =============== */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; padding:var(--pad);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:var(--bg); color:var(--text);
}
#wrap{max-width:1100px;margin:0 auto}
h1{margin:0 0 8px 0}

/* Controls */
#controls{display:grid;gap:8px;grid-template-columns:1fr;align-items:center;margin:8px 0 14px}
.controls-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
input#ab-search, select#ab-sort, select#ab-page-size{
  flex:1 1 auto; padding:10px 12px; border:1px solid var(--border); border-radius:var(--radius);
  background:var(--bg-2); color:var(--text)
}
button.btn{
  padding:10px 12px; border:1px solid var(--btn-border); border-radius:var(--radius);
  background:var(--btn-bg); color:var(--text); cursor:pointer
}
button.btn:focus, select:focus, input:focus{ outline:2px solid #2d72d2; outline-offset:2px }
#meta{color:var(--muted)}

/* Dark mode switch */
.switch{ display:inline-flex; align-items:center; gap:8px; user-select:none }
.switch .label{font-size:.95em; color:var(--muted)}
.switch input{display:none}
.switch .track{
  width:46px; height:26px; border-radius:999px; position:relative;
  background:var(--btn-border); transition:background .2s
}
.switch .thumb{
  width:20px; height:20px; border-radius:50%; position:absolute; top:3px; left:3px;
  background:#fff; transition:left .2s, background .2s
}
body.dark .switch .thumb{ background:#dbeafe }
.switch input:checked + .track .thumb{ left:23px }
.switch input:checked + .track{ background:#2d72d2 }

/* Table */
table{border-collapse:collapse;width:100%}
th, td{border:1px solid var(--border); padding:10px; vertical-align:middle}
th{background:var(--bg-2); user-select:none; position:sticky; top:0; z-index:1}
tr:nth-child(even){background:var(--row-alt)}
tbody tr:hover{background:var(--row-hover)}
th[data-type="num"]{text-align:right}
td:nth-child(4){text-align:right}

/* Covers */
td:first-child{width:72px; border-top: none; border-bottom: 1px solid var(--border); border-left: none; border-right: none;}
img.cover{width:56px;height:auto;border-radius:6px;display:block;border:none;box-shadow:none;background:transparent}
button.cover-btn{display:block;border:none;background:transparent;padding:0;cursor:pointer}
button.cover-btn:focus{ outline:2px solid #2d72d2; outline-offset:2px }

/* Cards (for small screens toggle) */
#ab-cards{display:none;grid-template-columns:1fr;gap:10px}
.ab-card{
  border:1px solid var(--border); border-radius:var(--radius); padding:12px;
  background:var(--bg-2)
}
.ab-card .t{font-weight:600;margin-bottom:4px;display:flex;align-items:center;gap:8px}
.ab-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:4px}
.ab-chip{background:var(--chip);padding:4px 8px;border-radius:999px;font-size:.9em;color:var(--text)}
.cover-inline{width:40px;height:auto;border-radius:6px;display:inline-block;vertical-align:middle}

/* Pagination */
.pagination{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.pagination-info{color:var(--muted)}
#ab-page-nav{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
.page-ellipsis{padding:6px 4px;color:var(--muted)}
.page-btn{
  padding:6px 10px; border:1px solid var(--btn-border); border-radius:10px;
  background:var(--btn-bg); cursor:pointer; color:var(--text)
}
.page-btn.active, .page-btn:disabled{background:var(--btn-bg-active); border-color:var(--btn-active); cursor:default}

/* Modal viewer */
#modal{
  position:fixed; inset:0; display:none; align-items:center; justify-content:center;
  background:var(--overlay); z-index:9999; padding:20px
}
#modal.open{ display:flex }
#modal .panel{
  width:min(960px, 95vw); max-height:90vh; overflow:auto;
  background:var(--bg); color:var(--text); border:1px solid var(--border);
  border-radius:16px; display:grid; grid-template-columns: 240px 1fr; gap:16px; padding:16px;
}
#modal .panel .cover-lg{ width: 100%; height:auto; border-radius:12px; display:block }
#modal .meta-grid{ display:grid; grid-template-columns: 120px 1fr; gap:8px; align-items:start }
#modal .label{ color:var(--muted) }
#modal .title{ font-size:1.1rem; font-weight:700; margin-bottom:6px }
#modal .desc{ margin-top:10px; line-height:1.45; white-space:pre-wrap; color:var(--text) }
#modal .close{
  position:absolute; top:14px; right:14px;
  background:var(--btn-bg); border:1px solid var(--btn-border); border-radius:10px;
  padding:8px 10px; cursor:pointer; color:var(--text)
}

/* Responsive */
@media (max-width: 820px){
  body.cards #ab-table{display:none}
  body.cards #ab-cards{display:grid}
  body:not(.cards) #ab-cards{display:none}
  body:not(.cards) #ab-table{display:table}
  th, td{padding:12px}
  input#ab-search, select#ab-sort, select#ab-page-size, button.btn{padding:12px 14px}
  #modal .panel{ grid-template-columns: 1fr; }
}
</style>
</head>

<body>
<div id="wrap">
  <h1>Audiobook Catalog</h1>

  <div id="controls">
    <div class="controls-row">
      <!-- Search input -->
      <input id="ab-search" type="search" placeholder="Search any field…" aria-label="Search" />

      <select id="ab-sort">
        <option value="title|txt">Sort by Title</option>
        <option value="series|txt">Sort by Series</option>
        <option value="series_index_sort|num">Sort by # (numeric)</option>
        <option value="author|txt">Sort by Author</option>
        <option value="narrator|txt">Sort by Narrator</option>
        <option value="year|txt">Sort by Year</option>
        <option value="genre|txt">Sort by Genre</option>
        <option value="duration_hhmm|txt">Sort by Duration</option>
      </select>
      <button id="ab-sort-asc" class="btn">Asc</button>
      <button id="ab-sort-desc" class="btn">Desc</button>
      <button id="ab-toggle-view" class="btn">Toggle View</button>

      <!-- Dark Mode switch -->
      <label class="switch" title="Toggle dark mode">
        <span class="label">Dark mode</span>
        <input id="ab-dark-toggle" type="checkbox" checked />
        <span class="track"><span class="thumb"></span></span>
      </label>
    </div>

    <div class="controls-row pagination">
      <label for="ab-page-size"><small>Rows per page:</small></label>
      <select id="ab-page-size">
        <option value="10">10</option>
        <option value="20">20</option>
        <option value="50">50</option>
        <option value="100" selected>100</option>
        <option value="500">500</option>
        <option value="All">All</option>
      </select>

      <button id="ab-page-first" class="btn">« First</button>
      <button id="ab-page-prev"  class="btn">‹ Prev</button>
      <div id="ab-page-nav"></div>
      <button id="ab-page-next"  class="btn">Next ›</button>
      <button id="ab-page-last"  class="btn">Last »</button>

      <span id="ab-page-info" class="pagination-info"></span>
    </div>

    <div id="meta"><small>
      Generated at: {{GENERATED_AT}} ·
      <a href="{{CSV_LINK}}" download>Download CSV</a>{{DRIVE_LINK_BLOCK}}
    </small></div>
  </div>

  <table id="ab-table">
    <thead><tr>
      <th data-key="cover_href">Cover</th>
      <th data-key="title">Title</th>
      <th data-key="series">Series</th>
      <th data-key="series_index_display" data-type="num">#</th>
      <th data-key="author">Author</th>
      <th data-key="narrator">Narrator</th>
      <th data-key="year">Year</th>
      <th data-key="genre">Genre</th>
      <th data-key="duration_hhmm">Duration (hh:mm)</th>
    </tr></thead>
    <tbody>{{TABLE_ROWS}}</tbody>
  </table>

  <div id="ab-cards">{{CARDS}}</div>
</div>

<!-- Modal -->
<div id="modal" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <button class="close" id="modal-close" aria-label="Close">Close ✕</button>
    <div>
      <img class="cover-lg" id="modal-cover" alt="">
    </div>
    <div>
      <div id="modal-title" class="title"></div>
      <div class="meta-grid">
        <div class="label">Series</div><div id="m-series"></div>
        <div class="label">#</div><div id="m-index"></div>
        <div class="label">Author</div><div id="m-author"></div>
        <div class="label">Narrator</div><div id="m-narrator"></div>
        <div class="label">Year</div><div id="m-year"></div>
        <div class="label">Genre</div><div id="m-genre"></div>
        <div class="label">Duration</div><div id="m-duration"></div>
      </div>
      <div class="desc" id="m-desc"></div>
    </div>
  </div>
</div>

<script>
/* ===== Theme bootstrap (default Dark ON) ===== */
(function(){
  var saved = localStorage.getItem("ab_theme");
  var startDark = (saved ? saved === "dark" : true);
  if (startDark) document.body.classList.add("dark");
  if (window.matchMedia("(max-width: 820px)").matches){ document.body.classList.add("cards"); }
  var tg = document.getElementById("ab-dark-toggle");
  if (tg) tg.checked = document.body.classList.contains("dark");
})();

/* ===== App logic: search, sort, pagination, modal ===== */
(function(){
  // Dark toggle
  var darkToggle = document.getElementById("ab-dark-toggle");
  if (darkToggle){
    darkToggle.addEventListener("change", function(){
      if (darkToggle.checked){ document.body.classList.add("dark");  localStorage.setItem("ab_theme","dark"); }
      else { document.body.classList.remove("dark"); localStorage.setItem("ab_theme","light"); }
    });
  }

  /* ---------- Utilities ---------- */
  function _debounce(fn, ms){
    var t;
    return function(){
      var ctx = this, args = arguments;
      clearTimeout(t);
      t = setTimeout(function(){ fn.apply(ctx, args); }, ms);
    };
  }
  function _normalize(s){
    return (s || "")
      .toString()
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"") // strip accents
      .toLowerCase()
      .replace(/\s+/g," ")
      .trim();
  }
  function _tokens(q){
    return _normalize(q).split(" ").filter(Boolean);
  }

  /* ---------- Sorting ---------- */
  function getCellVal(row, idx, numeric){
    var cell = row.children[idx]; if (!cell) return "";
    if (numeric){
      var key = cell.getAttribute("data-sort");
      if (key !== null && key !== ""){
        var n = parseFloat(key); if (!isNaN(n)) return n;
      }
      var txt = cell.innerText || cell.textContent || "";
      var n2 = parseFloat(txt); return isNaN(n2) ? -Infinity : n2;
    }
    return cell.innerText || cell.textContent || "";
  }
  function cmp(a,b,numeric){ return numeric ? (a-b) : (""+a).localeCompare(""+b,undefined,{numeric:true,sensitivity:"base"}) }
  function sortTableBy(table, idx, numeric, asc){
    var tbody = table.tBodies[0];
    var rows = Array.from(tbody.querySelectorAll("tr"));
    rows.sort(function(r1,r2){
      var v1 = getCellVal(r1, idx, numeric), v2 = getCellVal(r2, idx, numeric);
      return asc ? cmp(v1,v2,numeric) : cmp(v2,v1,numeric);
    });
    rows.forEach(function(r){ tbody.appendChild(r); });
    currentPage = 1; renderPage();
  }
  function makeTableSortable(table){
    var ths = table.querySelectorAll("th");
    ths.forEach(function(th, idx){
      var asc = true;
      if (th.getAttribute("data-key")==="cover_href"){ return; }
      th.style.cursor="pointer";
      th.addEventListener("click", function(){
        var numeric = th.dataset.type === "num";
        sortTableBy(table, idx, numeric, asc);
        asc = !asc;
      });
    });
  }

  /* ---------- Pagination (shared vars) ---------- */
  var pageSizeEl, pageNav, pageInfo, table, cardsWrap;
  var currentPage = 1;
  function matchedRows(){
    return Array.from(document.querySelectorAll("#ab-table tbody tr"))
      .filter(function(r){ return (r.dataset.searchMatch || "1") === "1"; });
  }
  function matchedCards(){
    return Array.from(document.querySelectorAll("#ab-cards .ab-card"))
      .filter(function(c){ return (c.dataset.searchMatch || "1") === "1"; });
  }
  function pageSize(){
    var v = pageSizeEl ? pageSizeEl.value : "100";
    if (v === "All") return Infinity;
    var n = parseInt(v, 10);
    return isNaN(n) ? 100 : n;
  }

  /* ---------- UPDATED renderPage: hide non-matches, show only paged matches ---------- */
  function renderPage(){
    var ps = pageSize();

    // All items
    var allRows  = Array.from(document.querySelectorAll("#ab-table tbody tr"));
    var allCards = Array.from(document.querySelectorAll("#ab-cards .ab-card"));

    // Hide non-matches up front
    allRows.forEach(function(r){
      var isMatch = (r.dataset.searchMatch || "1") === "1";
      r.style.display = isMatch ? "" : "none";
    });
    allCards.forEach(function(c){
      var isMatch = (c.dataset.searchMatch || "1") === "1";
      c.style.display = isMatch ? "" : "none";
    });

    // Work with matched sets for pagination
    var rows  = allRows.filter(function(r){ return (r.dataset.searchMatch || "1") === "1"; });
    var cards = allCards.filter(function(c){ return (c.dataset.searchMatch || "1") === "1"; });

    var totalRows = rows.length;
    var pagesRows = Math.max(1, Math.ceil(totalRows / ps));
    if (currentPage > pagesRows) currentPage = pagesRows;

    // Rows: only current page visible
    rows.forEach(function(r,i){
      var start = (currentPage-1)*ps, end = start+ps;
      r.style.display = (ps===Infinity || (i >= start && i < end)) ? "" : "none";
    });

    // Cards (if used)
    var pagesCards = Math.max(1, Math.ceil(cards.length / ps));
    var pages = Math.max(pagesRows, pagesCards);
    cards.forEach(function(c,i){
      var start = (currentPage-1)*ps, end = start+ps;
      c.style.display = (ps===Infinity || (i >= start && i < end)) ? "" : "none";
    });

    drawPager(pages, totalRows);
  }

  function drawPager(pages, total){
    if (!pageNav) return;
    pageNav.innerHTML = "";
    function pill(label, handler, active){
      var b = document.createElement("button");
      b.className = "page-btn" + (active ? " active" : "");
      b.textContent = label;
      b.addEventListener("click", handler);
      pageNav.appendChild(b);
    }
    document.getElementById("ab-page-first").onclick = function(){ currentPage = 1; renderPage(); }
    document.getElementById("ab-page-prev").onclick  = function(){ currentPage = Math.max(1, currentPage-1); renderPage(); }
    document.getElementById("ab-page-next").onclick  = function(){ currentPage = Math.min(pages, currentPage+1); renderPage(); }
    document.getElementById("ab-page-last").onclick  = function(){ currentPage = pages; renderPage(); }

    var windowSize = 2;
    var start = Math.max(1, currentPage - windowSize);
    var end   = Math.min(pages, currentPage + windowSize);
    if (start > 1){ pill(1, function(){ currentPage=1; renderPage(); }, currentPage===1); if (start>2) pageNav.append("…"); }
    for (var i=start;i<=end;i++){
      (function(i0){ pill(i0, function(){ currentPage=i0; renderPage(); }, i0===currentPage); })(i);
    }
    if (end < pages){ if (end < pages-1) pageNav.append("…"); pill(pages, function(){ currentPage=pages; renderPage(); }, currentPage===pages); }

    var ps = pageSize();
    if (pageInfo){
      if (ps===Infinity) pageInfo.textContent = "Showing all " + total + " items";
      else {
        var sIdx = (currentPage-1)*ps + 1;
        var eIdx = Math.min(total, currentPage*ps);
        pageInfo.textContent = "Showing " + sIdx + "–" + eIdx + " of " + total;
      }
    }
  }

  /* ---------- Search (tokenized AND) ---------- */
  function _buildSearchCache(){
    document.querySelectorAll("#ab-table tbody tr").forEach(function(r){
      if (!r.dataset._searchText){
        var parts = [];
        Array.from(r.cells).forEach(function(td){
          parts.push(td.innerText || td.textContent || "");
          var ds = td.getAttribute("data-sort"); if (ds) parts.push(ds);
        });
        r.dataset._searchText = _normalize(parts.join(" "));
        if (!("searchMatch" in r.dataset)) r.dataset.searchMatch = "1";
      }
    });
    document.querySelectorAll("#ab-cards .ab-card").forEach(function(c){
      if (!c.dataset._searchText){
        var keys = ["title","series","series_index_sort","author","narrator","year","genre","duration_hhmm"];
        var parts = keys.map(function(k){ return c.getAttribute("data-"+k) || ""; });
        parts.push(c.innerText || c.textContent || "");
        c.dataset._searchText = _normalize(parts.join(" "));
        if (!("searchMatch" in c.dataset)) c.dataset.searchMatch = "1";
      }
    });
  }
  function _applySearch(q){
    var toks = _tokens(q);
    var matchesAll = function(hay){ return toks.every(function(t){ return hay.indexOf(t) !== -1; }); };

    document.querySelectorAll("#ab-table tbody tr").forEach(function(r){
      var hay = r.dataset._searchText || "";
      r.dataset.searchMatch = (!toks.length || matchesAll(hay)) ? "1" : "0";
    });
    document.querySelectorAll("#ab-cards .ab-card").forEach(function(c){
      var hay = c.dataset._searchText || "";
      c.dataset.searchMatch = (!toks.length || matchesAll(hay)) ? "1" : "0";
    });
  }

  /* ---------- Modal ---------- */
  var modal = document.getElementById("modal");
  var modalCover = document.getElementById("modal-cover");
  var modalTitle = document.getElementById("modal-title");
  var mSeries = document.getElementById("m-series");
  var mIndex = document.getElementById("m-index");
  var mAuthor = document.getElementById("m-author");
  var mNarrator = document.getElementById("m-narrator");
  var mYear = document.getElementById("m-year");
  var mGenre = document.getElementById("m-genre");
  var mDuration = document.getElementById("m-duration");
  var mDesc = document.getElementById("m-desc");
  var modalClose = document.getElementById("modal-close");

  function openModal(payload){
    modalCover.src = payload.cover || "";
    modalCover.alt = payload.title || "";
    modalTitle.textContent = payload.title || "";
    mSeries.textContent = payload.series || "";
    mIndex.textContent = payload.index || "";
    mAuthor.textContent = payload.author || "";
    mNarrator.textContent = payload.narrator || "";
    mYear.textContent = payload.year || "";
    mGenre.textContent = payload.genre || "";
    mDuration.textContent = payload.duration || "";
    mDesc.textContent = payload.desc ? payload.desc : "No description available.";
    modal.classList.add("open");
    modal.setAttribute("aria-hidden","false");
  }
  function closeModal(){
    modal.classList.remove("open");
    modal.setAttribute("aria-hidden","true");
  }

  document.addEventListener("click", function(e){
    var btn = e.target.closest("button.cover-btn");
    if (btn){
      var d = btn.dataset;
      openModal({
        cover: d.cover || "",
        title: d.title || "",
        series: d.series || "",
        index: d.index || "",
        author: d.author || "",
        narrator: d.narrator || "",
        year: d.year || "",
        genre: d.genre || "",
        duration: d.duration || "",
        desc: d.desc || ""
      });
    }
  });
  if (modalClose) modalClose.addEventListener("click", closeModal);
  modal.addEventListener("click", function(e){ if (e.target === modal) closeModal(); });
  document.addEventListener("keydown", function(e){ if (e.key === "Escape") closeModal(); });

  /* ---------- Startup ---------- */
  document.addEventListener("DOMContentLoaded", function(){
    // Assign to shared vars (no 'var' here)
    table      = document.getElementById("ab-table");
    cardsWrap  = document.getElementById("ab-cards");
    pageSizeEl = document.getElementById("ab-page-size");
    pageNav    = document.getElementById("ab-page-nav");
    pageInfo   = document.getElementById("ab-page-info");

    if (table) makeTableSortable(table);

    // Initialize search cache/flags
    _buildSearchCache();
    document.querySelectorAll("#ab-table tbody tr").forEach(function(r){ if (!("searchMatch" in r.dataset)) r.dataset.searchMatch = "1"; });
    document.querySelectorAll("#ab-cards .ab-card").forEach(function(c){ if (!("searchMatch" in c.dataset)) c.dataset.searchMatch = "1"; });

    // Debounced search input
    var search = document.getElementById("ab-search");
    if (search){
      var onType = _debounce(function(){
        _applySearch(search.value);
        currentPage = 1;
        renderPage();
      }, 120);
      search.addEventListener("input", onType);
    }

    // Sort select + buttons
    var sortSelect = document.getElementById("ab-sort");
    var sortAscBtn = document.getElementById("ab-sort-asc");
    var sortDescBtn= document.getElementById("ab-sort-desc");
    function doSort(asc){
      var parts = sortSelect.value.split("|");
      var key = parts[0], numeric = (parts[1]==="num");

      // sort table
      var idx = Array.from(document.querySelectorAll("#ab-table thead th")).findIndex(function(th){
        return th.getAttribute("data-key") === key;
      });
      if (idx >= 0){
        var tbody = table.tBodies[0];
        var rows = Array.from(tbody.querySelectorAll("tr"));
        rows.sort(function(r1,r2){
          function getCellVal(row){
            var cell = row.children[idx];
            if (!cell) return "";
            if (numeric){
              var key2 = cell.getAttribute("data-sort");
              if (key2 !== null && key2 !== ""){
                var n = parseFloat(key2); if (!isNaN(n)) return n;
              }
              var txt = cell.innerText || cell.textContent || "";
              var n2 = parseFloat(txt); return isNaN(n2) ? -Infinity : n2;
            }
            return cell.innerText || cell.textContent || "";
          }
          var v1 = getCellVal(r1), v2 = getCellVal(r2);
          return asc ? ((numeric ? (v1-v2) : (""+v1).localeCompare(""+v2,undefined,{numeric:true,sensitivity:"base"})))
                     : ((numeric ? (v2-v1) : (""+v2).localeCompare(""+v1,undefined,{numeric:true,sensitivity:"base"})));
        });
        rows.forEach(function(r){ tbody.appendChild(r); });
      }

      // sort cards
      if (cardsWrap){
        var cards = Array.from(cardsWrap.querySelectorAll(".ab-card"));
        cards.sort(function(a,b){
          var v1 = a.getAttribute("data-"+key) || "";
          var v2 = b.getAttribute("data-"+key) || "";
          if (numeric){ v1 = parseFloat(v1); v2 = parseFloat(v2); if (isNaN(v1)) v1=-Infinity; if (isNaN(v2)) v2=-Infinity; }
          return asc ? ((numeric ? (v1-v2) : (""+v1).localeCompare(""+v2,undefined,{numeric:true,sensitivity:"base"})))
                     : ((numeric ? (v2-v1) : (""+v2).localeCompare(""+v1,undefined,{numeric:true,sensitivity:"base"})));
        });
        cards.forEach(function(c){ cardsWrap.appendChild(c); });
      }

      currentPage = 1; renderPage();
    }
    if (sortAscBtn) sortAscBtn.addEventListener("click", function(){ doSort(true); });
    if (sortDescBtn)sortDescBtn.addEventListener("click", function(){ doSort(false); });

    // Toggle cards/table view
    var toggle = document.getElementById("ab-toggle-view");
    if (toggle){
      toggle.addEventListener("click", function(){
        document.body.classList.toggle("cards");
        currentPage = 1; renderPage();
      });
    }

    // Page size change
    if (pageSizeEl){ pageSizeEl.addEventListener("change", function(){ currentPage=1; renderPage(); }); }

    // First paint
    _applySearch((document.getElementById("ab-search")||{}).value || "");
    renderPage();
  });
})();
</script>
</body>
</html>
