<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Audiobook Catalog</title>
<style>
/* =============== Theming =============== */
:root{
  --pad:14px; --radius:14px;
  --bg:#ffffff; --bg-2:#fafafa;
  --text:#1b1f23; --muted:#5f6b7a;
  --border:#e5e7eb;
  --chip:#f2f2f2;
  --btn-bg:#f7f7f7; --btn-bg-active:#e8f0fe; --btn-border:#ddd; --btn-active:#b6c6ff;
  --row-alt:#fcfcfc; --row-hover:#f5f9ff;
  --overlay: rgba(0,0,0,.55);
}
body.dark{
  --bg:#0f141a; --bg-2:#121820;
  --text:#e7eef7; --muted:#9fb0c6;
  --border:#263241;
  --chip:#1f2a37;
  --btn-bg:#1a2330; --btn-bg-active:#16324a; --btn-border:#2b3a4d; --btn-active:#2d72d2;
  --row-alt:#0f1722; --row-hover:#132033;
  --overlay: rgba(0,0,0,.65);
}

/* =============== Base Layout =============== */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; padding:var(--pad);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:var(--bg); color:var(--text);
}
#wrap{max-width:1100px;margin:0 auto}
h1{margin:0 0 8px 0}

/* Controls */
#controls{display:grid;gap:8px;grid-template-columns:1fr;align-items:center;margin:8px 0 14px}
.controls-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
input#ab-search, select#ab-sort, select#ab-page-size{
  flex:1 1 auto; padding:10px 12px; border:1px solid var(--border); border-radius:var(--radius);
  background:var(--bg-2); color:var(--text)
}
button.btn{
  padding:10px 12px; border:1px solid var(--btn-border); border-radius:var(--radius);
  background:var(--btn-bg); color:var(--text); cursor:pointer
}
button.btn:focus, select:focus, input:focus{ outline:2px solid #2d72d2; outline-offset:2px }
#meta{color:var(--muted)}

/* Dark mode switch */
.switch{ display:inline-flex; align-items:center; gap:8px; user-select:none }
.switch .label{font-size:.95em; color:var(--muted)}
.switch input{display:none}
.switch .track{
  width:46px; height:26px; border-radius:999px; position:relative;
  background:var(--btn-border); transition:background .2s
}
.switch .thumb{
  width:20px; height:20px; border-radius:50%; position:absolute; top:3px; left:3px;
  background:#fff; transition:left .2s, background .2s
}
body.dark .switch .thumb{ background:#dbeafe }
.switch input:checked + .track .thumb{ left:23px }
.switch input:checked + .track{ background:#2d72d2 }

/* Table */
table{border-collapse:collapse;width:100%}
th, td{border:1px solid var(--border); padding:10px; vertical-align:middle}
th{background:var(--bg-2); user-select:none; position:sticky; top:0; z-index:1}
tr:nth-child(even){background:var(--row-alt)}
tbody tr:hover{background:var(--row-hover)}
th[data-type="num"]{text-align:right}
td:nth-child(4){text-align:right}

/* Covers: de-bord cover cell + image/button */
td:first-child{width:72px; border-top: none; border-bottom: 1px solid var(--border); border-left: none; border-right: none;}
img.cover{width:56px;height:auto;border-radius:6px;display:block;border:none;box-shadow:none;background:transparent}
button.cover-btn{display:block;border:none;background:transparent;padding:0;cursor:pointer}
button.cover-btn:focus{ outline:2px solid #2d72d2; outline-offset:2px }

/* Cards */
#ab-cards{display:none;grid-template-columns:1fr;gap:10px}
.ab-card{
  border:1px solid var(--border); border-radius:var(--radius); padding:12px;
  background:var(--bg-2); cursor:pointer;
}
.ab-card:hover{background:var(--row-hover)}
.ab-card .t{font-weight:600;margin-bottom:4px;display:flex;align-items:center;gap:8px}
.ab-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:4px}
.ab-chip{background:var(--chip);padding:4px 8px;border-radius:999px;font-size:.9em;color:var(--text)}
.cover-inline{width:40px;height:auto;border-radius:6px;display:inline-block;vertical-align:middle}

/* Pagination */
.pagination{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.pagination-info{color:var(--muted)}
#ab-page-nav{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
.page-btn{
  padding:6px 10px; border:1px solid var(--btn-border); border-radius:10px;
  background:var(--btn-bg); cursor:pointer; color:var(--text)
}
.page-btn.active, .page-btn:disabled{background:var(--btn-bg-active); border-color:var(--btn-active); cursor:default}

/* Empty state */
#ab-empty{
  display:none;
  border:1px dashed var(--border);
  border-radius:14px;
  padding:18px;
  background:var(--bg-2);
  color:var(--muted);
  text-align:center;
  margin-top:10px;
}

/* Modal viewer */
#modal{
  position:fixed; inset:0; display:none; align-items:center; justify-content:center;
  background:var(--overlay); z-index:9999; padding:20px
}
#modal.open{ display:flex }
#modal .panel{
  width:min(960px, 95vw); max-height:90vh; overflow:auto;
  background:var(--bg); color:var(--text); border:1px solid var(--border);
  border-radius:16px; display:grid; grid-template-columns: 240px 1fr; gap:16px; padding:16px;
}
#modal .panel .cover-lg{ width: 100%; height:auto; border-radius:12px; display:block }
#modal .meta-grid{ display:grid; grid-template-columns: 120px 1fr; gap:8px; align-items:start }
#modal .label{ color:var(--muted) }
#modal .title{ font-size:1.1rem; font-weight:700; margin-bottom:6px }
#modal .desc{ margin-top:10px; line-height:1.45; white-space:pre-wrap; color:var(--text) }
#modal .close{
  position:absolute; top:14px; right:14px;
  background:var(--btn-bg); border:1px solid var(--btn-border); border-radius:10px;
  padding:8px 10px; cursor:pointer; color:var(--text)
}
/* Link-style buttons */
a.link-btn{
  display:inline-block;
  padding:8px 10px;
  border:1px solid var(--btn-border);
  border-radius:10px;
  background:var(--btn-bg);
  color:var(--text);
  text-decoration:none;
  margin-top:4px;
}
a.link-btn:focus{ outline:2px solid #2d72d2; outline-offset:2px }

/* Responsive */
@media (max-width: 820px){
  body.cards #ab-table{display:none}
  body.cards #ab-cards{display:grid}
  body:not(.cards) #ab-cards{display:none}
  body:not(.cards) #ab-table{display:table}
  th, td{padding:12px}
  input#ab-search, select#ab-sort, input#ab-page-size, button.btn{padding:12px 14px}
  #modal .panel{ grid-template-columns: 1fr; }
}

/* Make table rows look clickable */
#ab-table tbody tr{ cursor:pointer; }
</style>

<!-- Author → Drive map loaded from external JSON file -->
<script type="application/json" id="ab-author-map-json">
{{AUTHOR_MAP_JSON}}
</script>

<!-- Optional env hook (unused here) -->
<script>window.AB_AUTHOR_MAP_URL="{{AUTHOR_DRIVE_MAP_URL}}";</script>
</head>

<body>
<div id="wrap">
  <h1>Audiobook Catalog</h1>

  <div id="controls">
    <div class="controls-row">
      <input id="ab-search" type="search" placeholder="Search any field…" aria-label="Search" />
      <select id="ab-sort">
        <option value="title|txt">Sort by Title</option>
        <option value="series|txt">Sort by Series</option>
        <option value="series_index_sort|num">Sort by # (numeric)</option>
        <option value="author|txt">Sort by Author</option>
        <option value="narrator|txt">Sort by Narrator</option>
        <option value="year|txt">Sort by Year</option>
        <option value="genre|txt">Sort by Genre</option>
        <option value="duration_hhmm|txt">Sort by Duration</option>
      </select>
      <button id="ab-sort-asc" class="btn">Asc</button>
      <button id="ab-sort-desc" class="btn">Desc</button>
      <button id="ab-toggle-view" class="btn">Toggle View</button>

      <label class="switch" title="Toggle dark mode">
        <span class="label">Dark mode</span>
        <input id="ab-dark-toggle" type="checkbox" checked />
        <span class="track"><span class="thumb"></span></span>
      </label>
    </div>

    <div class="controls-row pagination">
      <label for="ab-page-size"><small>Rows per page:</small></label>
      <select id="ab-page-size">
        <option value="10">10</option>
        <option value="20">20</option>
        <option value="50">50</option>
        <option value="100" selected>100</option>
        <option value="500">500</option>
        <option value="All">All</option>
      </select>

      <button id="ab-page-first" class="btn">« First</button>
      <button id="ab-page-prev"  class="btn">‹ Prev</button>
      <div id="ab-page-nav"></div>
      <button id="ab-page-next"  class="btn">Next ›</button>
      <button id="ab-page-last"  class="btn">Last »</button>

      <span id="ab-page-info" class="pagination-info"></span>
    </div>

    <div id="meta"><small>
      Generated at: {{GENERATED_AT}} ·
      <a href="{{CSV_LINK}}" download>Download CSV</a>{{DRIVE_LINK_BLOCK}}
    </small></div>
  </div>

  <table id="ab-table">
    <thead><tr>
      <th data-key="cover_href">Cover</th>
      <th data-key="title">Title</th>
      <th data-key="series">Series</th>
      <th data-key="series_index_display" data-type="num">#</th>
      <th data-key="author">Author</th>
      <th data-key="narrator">Narrator</th>
      <th data-key="year">Year</th>
      <th data-key="genre">Genre</th>
      <th data-key="duration_hhmm">Duration (hh:mm)</th>
    </tr></thead>
    <tbody>{{TABLE_ROWS}}</tbody>
  </table>

  <div id="ab-cards">{{CARDS}}</div>

  <div id="ab-empty">No results for "<span id="ab-empty-q"></span>". Try a different search.</div>
</div>

<!-- Modal -->
<div id="modal" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <button class="close" id="modal-close" aria-label="Close">Close ✕</button>
    <div>
      <img class="cover-lg" id="modal-cover" alt="">
    </div>
    <div>
      <div id="modal-title" class="title"></div>

      <!-- Action buttons -->
      <div style="display:flex; gap:8px; flex-wrap:wrap; margin:2px 0 6px;">
        <a id="m-author-folder" class="link-btn" href="#" target="_blank" rel="noopener" style="display:none">Open author folder</a>
        <a id="m-author-drive" class="link-btn" href="#" target="_blank" rel="noopener" style="display:none">Search author in Drive</a>
        <a id="m-book-drive"   class="link-btn" href="#" target="_blank" rel="noopener" style="display:none">Search book in Drive</a>
      </div>

      <div class="meta-grid" style="margin-top:6px">
        <div class="label">Series</div><div id="m-series"></div>
        <div class="label">#</div><div id="m-index"></div>
        <div class="label">Author</div><div id="m-author"></div>
        <div class="label">Narrator</div><div id="m-narrator"></div>
        <div class="label">Year</div><div id="m-year"></div>
        <div class="label">Genre</div><div id="m-genre"></div>
        <div class="label">Duration</div><div id="m-duration"></div>
      </div>
      <div class="desc" id="m-desc"></div>
    </div>
  </div>
</div>

<script>
/* ===== Theme bootstrap (default Dark ON) ===== */
(function(){
  var saved = localStorage.getItem("ab_theme");
  var startDark = (saved ? saved === "dark" : true);
  if (startDark) document.body.classList.add("dark");
  if (window.matchMedia("(max-width: 820px)").matches){ document.body.classList.add("cards"); }
  var tg = document.getElementById("ab-dark-toggle");
  if (tg) tg.checked = document.body.classList.contains("dark");
})();

/* ===== App logic ===== */
(function(){
  /* Dark toggle */
  var darkToggle = document.getElementById("ab-dark-toggle");
  if (darkToggle){
    darkToggle.addEventListener("change", function(){
      if (darkToggle.checked){ document.body.classList.add("dark");  localStorage.setItem("ab_theme","dark"); }
      else { document.body.classList.remove("dark"); localStorage.setItem("ab_theme","light"); }
    });
  }

  /* Utils */
  function _debounce(fn, ms){ var t; return function(){ clearTimeout(t); var a=arguments,c=this; t=setTimeout(function(){ fn.apply(c,a); }, ms); }; }
  function _normalize(s){ return (s||"").toString().normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/\s+/g," ").trim(); }
  function _tokens(q){ return _normalize(q).split(" ").filter(Boolean); }

  /* Hash helpers */
  function _parseHash(){ var h=(location.hash||"").replace(/^#/,""); var sp=new URLSearchParams(h); var q=sp.get("q")||""; var p=parseInt(sp.get("p")||"1",10); return {q:q,p:isNaN(p)?1:p}; }
  function _writeHash(q,p){ var sp=new URLSearchParams(); if(q&&q.trim()) sp.set("q",q); if(p&&p>1) sp.set("p",String(p)); var nh="#"+sp.toString(); if(location.hash!==nh) history.replaceState(null,"",nh); }

  /* Sorting */
  function getCellVal(row,idx,numeric){ var cell=row.children[idx]; if(!cell) return ""; if(numeric){ var key=cell.getAttribute("data-sort"); if(key!==null&&key!==""){ var n=parseFloat(key); if(!isNaN(n)) return n; } var txt=cell.innerText||cell.textContent||""; var n2=parseFloat(txt); return isNaN(n2)?-Infinity:n2; } return cell.innerText||cell.textContent||""; }
  function cmp(a,b,numeric){ return numeric?(a-b):(""+a).localeCompare(""+b,undefined,{numeric:true,sensitivity:"base"}); }
  function sortTableBy(table,idx,numeric,asc){ var tbody=table.tBodies[0]; var rows=Array.from(tbody.querySelectorAll("tr")); rows.sort(function(r1,r2){ var v1=getCellVal(r1,idx,numeric),v2=getCellVal(r2,idx,numeric); return asc?cmp(v1,v2,numeric):cmp(v2,v1,numeric); }); rows.forEach(function(r){ tbody.appendChild(r); }); currentPage=1; renderPage(); }
  function makeTableSortable(table){ var ths=table.querySelectorAll("th"); ths.forEach(function(th,idx){ var asc=true; if(th.getAttribute("data-key")==="cover_href") return; th.style.cursor="pointer"; th.addEventListener("click",function(){ var numeric=th.dataset.type==="num"; sortTableBy(table,idx,numeric,asc); asc=!asc; }); }); }
  function getCardSortKey(card,key,numeric){ var v=card.getAttribute("data-"+key)||""; return numeric?(isNaN(parseFloat(v))?-Infinity:parseFloat(v)):v; }
  function sortCards(container,key,numeric,asc){ var cards=Array.from(container.querySelectorAll(".ab-card")); cards.sort(function(a,b){ var v1=getCardSortKey(a,key,numeric),v2=getCardSortKey(b,key,numeric); return asc?(numeric?(v1-v2):(""+v1).localeCompare(""+v2,undefined,{numeric:true,sensitivity:"base"})):(numeric?(v2-v1):(""+v2).localeCompare(""+v1,undefined,{numeric:true,sensitivity:"base"})); }); cards.forEach(function(c){ container.appendChild(c); }); currentPage=1; renderPage(); }

  /* Pagination */
  var pageSizeEl, pageNav, pageInfo, table, cardsWrap, emptyEl, emptyQEl;
  var currentPage=1;
  function pageSize(){ var v=pageSizeEl?pageSizeEl.value:"100"; if(v==="All") return Infinity; var n=parseInt(v,10); return isNaN(n)?100:n; }
  function renderPage(){
    var ps=pageSize();
    var rows=Array.from(document.querySelectorAll("#ab-table tbody tr"));
    var cards=Array.from(document.querySelectorAll("#ab-cards .ab-card"));

    rows.forEach(function(r){ var m=(r.dataset.searchMatch||"1")==="1"; r.style.display=m?"":"none"; });
    cards.forEach(function(c){ var m=(c.dataset.searchMatch||"1")==="1"; c.style.display=m?"":"none"; });

    rows=rows.filter(function(r){ return (r.dataset.searchMatch||"1")==="1"; });
    cards=cards.filter(function(c){ return (c.dataset.searchMatch||"1")==="1"; });

    var totalRows=rows.length;
    var pagesRows=Math.max(1,Math.ceil(totalRows/ps));
    if(currentPage>pagesRows) currentPage=pagesRows;

    rows.forEach(function(r,i){ var s=(currentPage-1)*ps,e=s+ps; r.style.display=(ps===Infinity||(i>=s&&i<e))?"":"none"; });

    var pagesCards=Math.max(1,Math.ceil(cards.length/ps));
    var pages=Math.max(pagesRows,pagesCards);
    cards.forEach(function(c,i){ var s=(currentPage-1)*ps,e=s+ps; c.style.display=(ps===Infinity||(i>=s&&i<e))?"":"none"; });

    var qVal=(document.getElementById("ab-search")&&document.getElementById("ab-search").value)||"";
    if(emptyEl){
      emptyEl.style.display = (totalRows===0 && qVal.trim()) ? "block" : "none";
      if (totalRows===0 && qVal.trim()) { emptyQEl.textContent=qVal; }
    }
    drawPager(pages,totalRows);
    _writeHash(qVal,currentPage);
  }
  function drawPager(pages,total){
    if(!pageNav) return;
    pageNav.innerHTML="";
    function pill(label,handler,active){ var b=document.createElement("button"); b.className="page-btn"+(active?" active":""); b.textContent=label; b.addEventListener("click",handler); pageNav.appendChild(b); }
    document.getElementById("ab-page-first").onclick=function(){ currentPage=1; renderPage(); }
    document.getElementById("ab-page-prev").onclick =function(){ currentPage=Math.max(1,currentPage-1); renderPage(); }
    document.getElementById("ab-page-next").onclick =function(){ currentPage=Math.min(pages,currentPage+1); renderPage(); }
    document.getElementById("ab-page-last").onclick =function(){ currentPage=pages; renderPage(); }

    var windowSize=2, start=Math.max(1,currentPage-windowSize), end=Math.min(pages,currentPage+windowSize);
    if(start>1){ pill(1,function(){ currentPage=1; renderPage(); }, currentPage===1); if(start>2) pageNav.append("…"); }
    for(var i=start;i<=end;i++){ (function(i0){ pill(i0,function(){ currentPage=i0; renderPage(); }, i0===currentPage); })(i); }
    if(end<pages){ if(end<pages-1) pageNav.append("…"); pill(pages,function(){ currentPage=pages; renderPage(); }, currentPage===pages); }

    var ps=pageSize();
    if(pageInfo){
      if(total===0){ pageInfo.textContent="No results"; }
      else if(ps===Infinity){ pageInfo.textContent="Showing all "+total+" items"; }
      else{ var sIdx=(currentPage-1)*ps+1, eIdx=Math.min(total,currentPage*ps); pageInfo.textContent="Showing "+sIdx+"–"+eIdx+" of "+total; }
    }
  }

  /* Search cache */
  function _buildSearchCache(){
    document.querySelectorAll("#ab-table tbody tr").forEach(function(r){
      if(!r.dataset._searchText){
        var parts=[];
        Array.from(r.cells).forEach(function(td){
          parts.push(td.innerText||td.textContent||"");
          var ds=td.getAttribute("data-sort"); if(ds) parts.push(ds);
        });
        r.dataset._searchText=_normalize(parts.join(" "));
        if(!("searchMatch" in r.dataset)) r.dataset.searchMatch="1";
      }
    });
    document.querySelectorAll("#ab-cards .ab-card").forEach(function(c){
      if(!c.dataset._searchText){
        var keys=["title","series","series_index_sort","author","narrator","year","genre","duration_hhmm"];
        var parts=keys.map(function(k){ return c.getAttribute("data-"+k)||""; });
        parts.push(c.innerText||c.textContent||"");
        c.dataset._searchText=_normalize(parts.join(" "));
        if(!("searchMatch" in c.dataset)) c.dataset.searchMatch="1";
      }
    });
  }
  function _applySearch(q){
    var toks=_tokens(q);
    var matchesAll=function(h){ return toks.every(function(t){ return h.indexOf(t)!==-1; }); };
    document.querySelectorAll("#ab-table tbody tr").forEach(function(r){
      var hay=r.dataset._searchText||""; r.dataset.searchMatch=(!toks.length||matchesAll(hay))?"1":"0";
    });
    document.querySelectorAll("#ab-cards .ab-card").forEach(function(c){
      var hay=c.dataset._searchText||""; c.dataset.searchMatch=(!toks.length||matchesAll(hay))?"1":"0";
    });
  }

  /* Author → Drive map from inline JSON */
  var AUTHOR_MAP={};
  function _loadAuthorMapInline(){
    try{
      var el=document.getElementById("ab-author-map-json");
      if(!el) return;
      var txt=(el.textContent||"").trim();
      if(!txt) return;
      var parsed=JSON.parse(txt);
      if(parsed && typeof parsed==="object"){ AUTHOR_MAP=parsed; }
    }catch(e){ /* ignore parse errors */ }
  }
  function _resolveAuthorFolder(author){
    if(!author) return null;
    if(AUTHOR_MAP[author]) return AUTHOR_MAP[author];
    var aNorm=author.toLowerCase().trim();
    for(var k in AUTHOR_MAP){
      if(!Object.prototype.hasOwnProperty.call(AUTHOR_MAP,k)) continue;
      if(k.toLowerCase().trim()===aNorm) return AUTHOR_MAP[k];
    }
    return null;
  }
  function _authorFolderHref(author){
    var id=_resolveAuthorFolder(author);
    return (id && String(id).trim())
      ? ("https://drive.google.com/drive/folders/"+encodeURIComponent(String(id).trim()))
      : null;
  }
  function _authorSearchHref(author){
    return author && author.trim()
      ? ("https://drive.google.com/drive/search?q="+encodeURIComponent(author.trim()))
      : null;
  }
  function _bookSearchHref(title){
    var clean=(title||"").toString().trim();
    if(clean.startsWith('"') && clean.endsWith('"')) clean=clean.slice(1,-1).trim();
    return clean ? ("https://drive.google.com/drive/search?q="+encodeURIComponent(clean)) : null;
  }

  /* Modal logic */
  var modal=document.getElementById("modal");
  var modalCover=document.getElementById("modal-cover");
  var modalTitle=document.getElementById("modal-title");
  var mSeries=document.getElementById("m-series");
  var mIndex=document.getElementById("m-index");
  var mAuthor=document.getElementById("m-author");
  var mNarrator=document.getElementById("m-narrator");
  var mYear=document.getElementById("m-year");
  var mGenre=document.getElementById("m-genre");
  var mDuration=document.getElementById("m-duration");
  var mDesc=document.getElementById("m-desc");

  var mAuthorDrive=document.getElementById("m-author-drive");
  var mAuthorFolder=document.getElementById("m-author-folder");
  var mBookDrive=document.getElementById("m-book-drive");
  var modalClose=document.getElementById("modal-close");

  function openModal(payload){
    modalCover.src=payload.cover||"";
    modalCover.alt=payload.title||"";
    modalTitle.textContent=payload.title||"";
    mSeries.textContent=payload.series||"";
    mIndex.textContent=payload.index||"";
    mAuthor.textContent=payload.author||"";
    mNarrator.textContent=payload.narrator||"";
    mYear.textContent=payload.year||"";
    mGenre.textContent=payload.genre||"";
    mDuration.textContent=payload.duration||"";
    mDesc.textContent=payload.desc ? payload.desc : "No description available.";

    var author=payload.author||"";
    var folderHref=_authorFolderHref(author);
    var authorSearchHref=_authorSearchHref(author);
    var bookHref=_bookSearchHref(payload.title||"");

    if(folderHref){
      mAuthorFolder.href=folderHref;
      mAuthorFolder.style.display="inline-block";
    } else {
      mAuthorFolder.removeAttribute("href");
      mAuthorFolder.style.display="none";
    }

    if(authorSearchHref){
      mAuthorDrive.href=authorSearchHref;
      mAuthorDrive.style.display="inline-block";
    } else {
      mAuthorDrive.removeAttribute("href");
      mAuthorDrive.style.display="none";
    }

    if(bookHref){
      mBookDrive.href=bookHref;
      mBookDrive.style.display="inline-block";
    } else {
      mBookDrive.removeAttribute("href");
      mBookDrive.style.display="none";
    }

    modal.classList.add("open");
    modal.setAttribute("aria-hidden","false");
  }
  function closeModal(){ modal.classList.remove("open"); modal.setAttribute("aria-hidden","true"); }

  // Cover button -> open
  document.addEventListener("click", function(e){
    var btn=e.target.closest("button.cover-btn");
    if(btn){
      var d=btn.dataset;
      openModal({
        cover:d.cover||"", title:d.title||"", series:d.series||"", index:d.index||"",
        author:d.author||"", narrator:d.narrator||"", year:d.year||"",
        genre:d.genre||"", duration:d.duration||"", desc:d.desc||""
      });
    }
  });

  // Any cell / row click -> open (unless clicking an interactive element)
  document.addEventListener("click", function(e){
    var td=e.target.closest("#ab-table tbody td");
    if(!td) return;
    if (e.target.closest("a,button") && !e.target.closest("button.cover-btn")) return;
    var tr=td.parentElement; if(!tr) return;
    var coverBtn=tr.querySelector("button.cover-btn"); if(!coverBtn) return;
    var d=coverBtn.dataset;
    openModal({
      cover:d.cover||"", title:d.title||"", series:d.series||"", index:d.index||"",
      author:d.author||"", narrator:d.narrator||"", year:d.year||"",
      genre:d.genre||"", duration:d.duration||"", desc:d.desc||""
    });
  });

  // Card click -> open modal (improved functionality)
  document.addEventListener("click", function(e){
    var card=e.target.closest(".ab-card");
    if(!card) return;
    if (e.target.closest("a,button")) return; // Don't trigger on interactive elements
    
    var d=card.dataset;
    openModal({
      cover:d.cover||"", title:d.title||"", series:d.series||"", index:d.index||"",
      author:d.author||"", narrator:d.narrator||"", year:d.year||"",
      genre:d.genre||"", duration:d.duration||"", desc:d.desc||""
    });
  });

  if(modalClose) modalClose.addEventListener("click", closeModal);
  modal.addEventListener("click", function(e){ if(e.target===modal) closeModal(); });
  document.addEventListener("keydown", function(e){ if(e.key==="Escape") closeModal(); });

  document.addEventListener("DOMContentLoaded", function(){
    _loadAuthorMapInline();

    table=document.getElementById("ab-table");
    cardsWrap=document.getElementById("ab-cards");
    pageSizeEl=document.getElementById("ab-page-size");
    pageNav=document.getElementById("ab-page-nav");
    pageInfo=document.getElementById("ab-page-info");
    emptyEl=document.getElementById("ab-empty");
    emptyQEl=document.getElementById("ab-empty-q");

    if(table) makeTableSortable(table);

    document.querySelectorAll("#ab-table tbody tr").forEach(function(r){ r.dataset.searchMatch="1"; });
    document.querySelectorAll("#ab-cards .ab-card").forEach(function(c){ c.dataset.searchMatch="1"; });
    _buildSearchCache();

    var search=document.getElementById("ab-search");
    if(search) search.addEventListener("input", _debounce(function(){ _applySearch(search.value); currentPage=1; renderPage(); }, 120));

    var sortSelect=document.getElementById("ab-sort");
    var sortAscBtn=document.getElementById("ab-sort-asc");
    var sortDescBtn=document.getElementById("ab-sort-desc");
    function doSort(asc){
      var parts=sortSelect.value.split("|");
      var key=parts[0], numeric=(parts[1]==="num");
      var idx=Array.from(document.querySelectorAll("#ab-table thead th")).findIndex(function(th){ return th.getAttribute("data-key")===key; });
      if(idx>=0){ sortTableBy(table, idx, numeric, asc); }
      var cards=Array.from(cardsWrap.querySelectorAll(".ab-card"));
      cards.sort(function(a,b){
        var v1=a.getAttribute("data-"+key)||"", v2=b.getAttribute("data-"+key)||"";
        if(numeric){ v1=parseFloat(v1); v2=parseFloat(v2); if(isNaN(v1)) v1=-Infinity; if(isNaN(v2)) v2=-Infinity; }
        return asc ? ((numeric ? (v1-v2) : (""+v1).localeCompare(""+v2,undefined,{numeric:true,sensitivity:"base"})))
                   : ((numeric ? (v2-v1) : (""+v2).localeCompare(""+v1,undefined,{numeric:true,sensitivity:"base"})));
      });
      cards.forEach(function(c){ cardsWrap.appendChild(c); });
      currentPage=1; renderPage();
    }
    if(sortAscBtn) sortAscBtn.addEventListener("click", function(){ doSort(true); });
    if(sortDescBtn)sortDescBtn.addEventListener("click", function(){ doSort(false); });

    var toggle=document.getElementById("ab-toggle-view");
    if(toggle){ toggle.addEventListener("click", function(){ document.body.classList.toggle("cards"); currentPage=1; renderPage(); }); }

    if(pageSizeEl){ pageSizeEl.addEventListener("change", function(){ currentPage=1; renderPage(); }); }

    var hashState=_parseHash();
    if(search && hashState.q){ search.value=hashState.q; _applySearch(hashState.q); }
    if(hashState.p>1){ currentPage=hashState.p; }
    if(!hashState.q){ _applySearch((search||{}).value||""); }
    renderPage();

    window.addEventListener("hashchange", function(){
      var s2=_parseHash();
      var curQ=(search&&search.value)||"";
      if(search && s2.q!==curQ){ search.value=s2.q||""; _applySearch(search.value); }
      currentPage=s2.p||1; renderPage();
    });
  });
})();
</script>
</body>
</html>